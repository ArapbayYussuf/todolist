{% extends 'base.html' %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h2 class="text-center mb-4">Список задач</h2>

            <!-- Поле поиска -->
            <div class="mb-4">
                <input type="text" class="form-control" id="search-input" placeholder="Поиск по названию, описанию или тегам..." onkeyup="loadTasks()">
            </div>

            <!-- Форма фильтрации -->
            <form id="filter-form" class="mb-4">
                <div class="row g-3">
                    <!-- Фильтр по категории -->
                    <div class="col-md-3">
                        <label for="category" class="form-label">Категория</label>
                        <select class="form-control" id="category" name="category">
                            <option value="">Все категории</option>
                        </select>
                    </div>
                    <!-- Фильтр по тегам -->
                    <div class="col-md-3">
                        <label for="tags" class="form-label">Тег</label>
                        <select class="form-control" id="tags" name="tags">
                            <option value="">Все теги</option>
                        </select>
                    </div>
                    <!-- Фильтр по приоритету -->
                    <div class="col-md-2">
                        <label for="priority" class="form-label">Приоритет</label>
                        <select class="form-control" id="priority" name="priority">
                            <option value="">Все</option>
                            <option value="low">Низкий</option>
                            <option value="medium">Средний</option>
                            <option value="high">Высокий</option>
                        </select>
                    </div>
                    <!-- Фильтр по статусу -->
                    <div class="col-md-2">
                        <label for="completed" class="form-label">Статус</label>
                        <select class="form-control" id="completed" name="completed">
                            <option value="">Все</option>
                            <option value="true">Выполненные</option>
                            <option value="false">Невыполненные</option>
                        </select>
                    </div>
                    <!-- Сортировка -->
                    <div class="col-md-2">
                        <label for="ordering" class="form-label">Сортировка</label>
                        <select class="form-control" id="ordering" name="ordering">
                            <option value="created_at">По дате (сначала старые)</option>
                            <option value="-created_at">По дате (сначала новые)</option>
                            <option value="priority">По приоритету (А-Я)</option>
                            <option value="-priority">По приоритету (Я-А)</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <button type="submit" class="btn btn-primary me-2">Применить</button>
                        <button type="button" class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
                    </div>
                </div>
            </form>

            <!-- Список задач -->
            <div id="task-list" class="mb-4"></div>
            <div id="task-message" class="mt-3 text-center"></div>
        </div>
    </div>

    <script>
        // Проверка авторизации
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/';
            throw new Error('Не авторизован');
        }

        // Загрузка категорий
        fetch('/api/categories/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        })
        .then(response => response.json())
        .then(categories => {
            const categorySelect = document.getElementById('category');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки категорий:', error);
        });

        // Загрузка тегов
        fetch('/api/tags/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        })
        .then(response => response.json())
        .then(tags => {
            const tagSelect = document.getElementById('tags');
            if (tags.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Нет тегов';
                option.disabled = true;
                tagSelect.appendChild(option);
            } else {
                tags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name;
                    tagSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки тегов:', error);
        });

        // Функция для построения URL с параметрами фильтрации и поиска
        function buildFilterUrl() {
            const form = document.getElementById('filter-form');
            const searchInput = document.getElementById('search-input');
            const formData = new FormData(form);
            const params = new URLSearchParams();

            formData.forEach((value, key) => {
                if (value) {
                    params.append(key, value);
                }
            });

            const searchQuery = searchInput.value.trim();
            if (searchQuery) {
                params.append('search', searchQuery);
            }

            return `/api/tasks/?${params.toString()}`;
        }

        // Функция для загрузки и отображения задач
        function loadTasks() {
            const url = buildFilterUrl();
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Не удалось загрузить задачи: ' + response.status);
                }
                return response.json();
            })
            .then(tasks => {
                console.log('Полученные задачи:', tasks);
                const taskList = document.getElementById('task-list');
                taskList.innerHTML = '';
                if (tasks.length === 0) {
                    taskList.innerHTML = '<p class="text-center">Нет задач, соответствующих фильтру или поиску.</p>';
                    return;
                }

                tasks.forEach(task => {
                    const categoryPromise = task.category
                        ? fetch(`/api/categories/${task.category}/`, {
                            headers: {
                                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                            }
                        })
                            .then(res => res.json())
                            .then(category => category.name)
                            .catch(() => 'Без категории')
                        : Promise.resolve('Без категории');

                    const tagsPromise = task.tags.length > 0
                        ? Promise.all(task.tags.map(tagId =>
                            fetch(`/api/tags/${tagId}/`, {
                                headers: {
                                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                                }
                            })
                                .then(res => res.json())
                                .then(tag => tag.name)
                        ))
                            .then(tagNames => tagNames.join(', ') || 'Без тегов')
                            .catch(() => 'Без тегов')
                        : Promise.resolve('Без тегов');

                    Promise.all([categoryPromise, tagsPromise]).then(([categoryName, tagNames]) => {
                        const priorityColor = task.priority === 'high' ? 'text-danger' :
                                            task.priority === 'medium' ? 'text-warning' :
                                            'text-success';
                        const taskCard = document.createElement('div');
                        taskCard.className = 'card bg-dark text-light mb-3';
                        taskCard.innerHTML = `
                            <div class="card-body">
                                <h5 class="card-title">${task.title}</h5>
                                <p class="card-text">${task.description || 'Без описания'}</p>
                                <p class="card-text"><strong>Категория:</strong> ${categoryName}</p>
                                <p class="card-text"><strong>Теги:</strong> ${tagNames}</p>
                                <p class="card-text"><strong>Приоритет:</strong> <span class="${priorityColor}">${
                                    task.priority === 'high' ? 'Высокий' :
                                    task.priority === 'medium' ? 'Средний' : 'Низкий'
                                }</span></p>
                                <p class="card-text"><strong>Статус:</strong> ${
                                    task.completed ? 'Выполнено' : 'Не выполнено'
                                }</p>
                                <div class="d-flex justify-content-end">
                                    <button class="btn btn-warning me-2" onclick="editTask(${task.id})">Редактировать</button>
                                    <button class="btn btn-danger" onclick="deleteTask(${task.id})">Удалить</button>
                                </div>
                            </div>
                        `;
                        taskList.appendChild(taskCard);
                    });
                });
            })
            .catch(error => {
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + error.message + '</div>';
                console.error('Ошибка:', error);
            });
        }

        // Функция сброса фильтров
        function resetFilters() {
            document.getElementById('filter-form').reset();
            document.getElementById('search-input').value = '';
            loadTasks();
        }

        // Обработчик отправки формы фильтрации
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault();
            loadTasks();
        });

        // Обработчик изменения сортировки
        document.getElementById('ordering').addEventListener('change', function() {
            loadTasks();
        });

        function deleteTask(taskId) {
            if (!confirm('Вы уверены, что хотите удалить эту задачу?')) return;

            fetch(`/api/tasks/${taskId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Не удалось удалить задачу: ' + response.status);
                }
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-success">Задача успешно удалена!</div>';
                loadTasks();
            })
            .catch(error => {
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + error.message + '</div>';
            });
        }

        function editTask(taskId) {
            window.location.href = `/tasks/edit/${taskId}/`;
        }

        // Загрузка задач при загрузке страницы
        loadTasks();
    </script>
{% endblock %}