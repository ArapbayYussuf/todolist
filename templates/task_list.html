{% extends 'base.html' %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-10">
            <h2 class="text-center mb-4">Список задач</h2>

            <!-- Поле поиска -->
            <div class="mb-4">
                <input type="text" class="form-control" id="search-input" placeholder="Поиск по названию, описанию или тегам..." onkeyup="loadTasks()">
            </div>

            <!-- Форма фильтрации -->
            <form id="filter-form" class="mb-4">
                <div class="row g-3">
                    <!-- Фильтр по категории -->
                    <div class="col-md-3">
                        <label for="category" class="form-label">Категория</label>
                        <select class="form-control" id="category" name="category">
                            <option value="">Все категории</option>
                        </select>
                    </div>
                    <!-- Фильтр по тегам -->
                    <div class="col-md-3">
                        <label for="tags" class="form-label">Тег</label>
                        <select class="form-control" id="tags" name="tags">
                            <option value="">Все теги</option>
                        </select>
                    </div>
                    <!-- Фильтр по приоритету -->
                    <div class="col-md-2">
                        <label for="priority" class="form-label">Приоритет</label>
                        <select class="form-control" id="priority" name="priority">
                            <option value="">Все</option>
                            <option value="low">Низкий</option>
                            <option value="medium">Средний</option>
                            <option value="high">Высокий</option>
                        </select>
                    </div>
                    <!-- Фильтр по статусу -->
                    <div class="col-md-2">
                        <label for="completed" class="form-label">Статус</label>
                        <select class="form-control" id="completed" name="completed">
                            <option value="">Все</option>
                            <option value="true">Выполненные</option>
                            <option value="false">Невыполненные</option>
                        </select>
                    </div>
                    <!-- Сортировка -->
                    <div class="col-md-2">
                        <label for="ordering" class="form-label">Сортировка</label>
                        <select class="form-control" id="ordering" name="ordering">
                            <option value="created_at">По дате (сначала старые)</option>
                            <option value="-created_at">По дате (сначала новые)</option>
                            <option value="priority">По приоритету (А-Я)</option>
                            <option value="-priority">По приоритету (Я-А)</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col">
                        <button type="submit" class="btn btn-primary me-2">Применить</button>
                        <button type="button" class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
                    </div>
                </div>
            </form>

            <!-- Список невыполненных задач -->
            <h3 class="mb-3">Невыполненные задачи</h3>
            <div id="task-list" class="mb-4"></div>

            <!-- Список выполненных задач -->
            <h3 class="mb-3">Выполненные задачи</h3>
            <div id="completed-task-list" class="mb-4"></div>

            <div id="task-message" class="mt-3 text-center"></div>
        </div>
    </div>

    <script>
        // Проверка авторизации
        if (!localStorage.getItem('access_token')) {
            window.location.href = '/';
            throw new Error('Не авторизован');
        }

        // Хранилище для состояния задач
        let taskState = JSON.parse(localStorage.getItem('taskState')) || {};

        // Загрузка категорий
        fetch('/api/categories/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        })
        .then(response => response.json())
        .then(categories => {
            const categorySelect = document.getElementById('category');
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки категорий:', error);
        });

        // Загрузка тегов
        fetch('/api/tags/', {
            method: 'GET',
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        })
        .then(response => response.json())
        .then(tags => {
            const tagSelect = document.getElementById('tags');
            if (tags.length === 0) {
                const option = document.createElement('option');
                option.value = '';
                option.textContent = 'Нет тегов';
                option.disabled = true;
                tagSelect.appendChild(option);
            } else {
                tags.forEach(tag => {
                    const option = document.createElement('option');
                    option.value = tag.id;
                    option.textContent = tag.name;
                    tagSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки тегов:', error);
        });

        // Функция для построения URL с параметрами фильтрации и поиска
        function buildFilterUrl() {
            const form = document.getElementById('filter-form');
            const searchInput = document.getElementById('search-input');
            const formData = new FormData(form);
            const params = new URLSearchParams();

            formData.forEach((value, key) => {
                if (value) {
                    params.append(key, value);
                }
            });

            const searchQuery = searchInput.value.trim();
            if (searchQuery) {
                params.append('search', searchQuery);
            }

            return `/api/tasks/?${params.toString()}`;
        }

        // Функция для загрузки и отображения задач
        function loadTasks() {
            const url = buildFilterUrl();
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Не удалось загрузить задачи: ' + response.status);
                }
                return response.json();
            })
            .then(tasks => {
                console.log('Полученные задачи:', tasks);
                const taskList = document.getElementById('task-list');
                const completedTaskList = document.getElementById('completed-task-list');
                taskList.innerHTML = '';
                completedTaskList.innerHTML = '';

                // Синхронизируем локальное состояние с данными от API
                tasks.forEach(task => {
                    taskState[task.id] = task.completed;
                });
                localStorage.setItem('taskState', JSON.stringify(taskState));

                // Разделяем задачи
                const activeTasks = tasks.filter(task => !task.completed);
                const completedTasksList = tasks.filter(task => task.completed);

                if (activeTasks.length === 0) {
                    taskList.innerHTML = '<p class="text-center">Нет невыполненных задач.</p>';
                } else {
                    activeTasks.forEach(task => renderTask(task, taskList));
                }

                if (completedTasksList.length === 0) {
                    completedTaskList.innerHTML = '<p class="text-center">Нет выполненных задач.</p>';
                } else {
                    completedTasksList.forEach(task => renderTask(task, completedTaskList));
                }
            })
            .catch(error => {
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + error.message + '</div>';
                console.error('Ошибка:', error);
            });
        }

        // Функция для рендеринга задачи
        function renderTask(task, container) {
            const categoryPromise = task.category
                ? fetch(`/api/categories/${task.category}/`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                    }
                })
                    .then(res => res.json())
                    .then(category => category.name)
                    .catch(() => 'Без категории')
                : Promise.resolve('Без категории');

            const tagsPromise = task.tags.length > 0
                ? Promise.all(task.tags.map(tagId =>
                    fetch(`/api/tags/${tagId}/`, {
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                        }
                    })
                        .then(res => res.json())
                        .then(tag => tag.name)
                ))
                    .then(tagNames => tagNames.join(', ') || 'Без тегов')
                    .catch(() => 'Без тегов')
                : Promise.resolve('Без тегов');

            Promise.all([categoryPromise, tagsPromise]).then(([categoryName, tagNames]) => {
                const priorityColor = task.priority === 'high' ? 'text-danger' :
                                    task.priority === 'medium' ? 'text-warning' :
                                    'text-success';
                const taskCard = document.createElement('div');
                taskCard.className = 'card bg-dark text-light mb-3';
                const isCompleted = task.completed;
                taskCard.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${task.title}</h5>
                        <p class="card-text">${task.description || 'Без описания'}</p>
                        <p class="card-text"><strong>Категория:</strong> ${categoryName}</p>
                        <p class="card-text"><strong>Теги:</strong> ${tagNames}</p>
                        <p class="card-text"><strong>Приоритет:</strong> <span class="${priorityColor}">${
                            task.priority === 'high' ? 'Высокий' :
                            task.priority === 'medium' ? 'Средний' : 'Низкий'
                        }</span></p>
                        <p class="card-text"><strong>Статус:</strong> ${
                            isCompleted ? 'Выполнено' : 'Не выполнено'
                        }</p>
                        <div class="d-flex justify-content-end">
                            <button class="btn ${isCompleted ? 'btn-success' : 'btn-warning'} me-2 complete-task-btn" data-task-id="${task.id}" ${
                                isCompleted ? 'disabled' : ''
                            }>${
                                isCompleted ? 'Выполнено' : 'Задание выполнено'
                            }</button>
                            <button class="btn btn-danger" onclick="deleteTask(${task.id})">Удалить</button>
                        </div>
                    </div>
                `;
                container.appendChild(taskCard);

                if (!isCompleted) {
                    taskCard.querySelector('.complete-task-btn').addEventListener('click', function() {
                        completeTask(task.id, this);
                    });
                }
            });
        }

        // Функция для завершения задачи
        function completeTask(taskId, button) {
            const accessToken = localStorage.getItem('access_token');
            fetch(`/api/tasks/${taskId}/`, {
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + accessToken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ completed: true })
            })
            .then(response => {
                if (!response.ok) throw new Error('Не удалось обновить задачу: ' + response.status);
                // Обновляем кнопку сразу
                button.classList.remove('btn-warning');
                button.classList.add('btn-success');
                button.disabled = true;
                button.textContent = 'Выполнено';
                // Обновляем локальное состояние
                taskState[taskId] = true;
                localStorage.setItem('taskState', JSON.stringify(taskState));
                // Перемещаем задачу
                updateTaskListAfterCompletion(taskId);
                // Обновляем статистику
                updateMainStats();
            })
            .catch(error => {
                console.error('Ошибка:', error);
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + error.message + '</div>';
            });
        }

        // Функция для обновления списка задач после завершения
        function updateTaskListAfterCompletion(taskId) {
            const taskList = document.getElementById('task-list');
            const completedTaskList = document.getElementById('completed-task-list');
            const taskCard = taskList.querySelector(`[data-task-id="${taskId}"]`)?.closest('.card');
            if (taskCard) {
                taskCard.remove();
                if (taskList.children.length === 0) {
                    taskList.innerHTML = '<p class="text-center">Нет невыполненных задач.</p>';
                }
            }
            // Загружаем обновлённую задачу
            fetch(`/api/tasks/${taskId}/`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => response.json())
            .then(task => {
                if (completedTaskList.children.length === 0) {
                    completedTaskList.innerHTML = '';
                }
                renderTask(task, completedTaskList);
            });
        }

        // Обновление статистики на главной странице
        function updateMainStats() {
            const accessToken = localStorage.getItem('access_token');
            fetch('/api/tasks/', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + accessToken
                }
            })
            .then(response => response.json())
            .then(tasks => {
                const activeTasks = tasks.filter(task => !task.completed).length;
                const completedTasks = tasks.filter(task => task.completed).length;
                localStorage.setItem('activeTasks', activeTasks);
                localStorage.setItem('completedTasks', completedTasks);
                window.dispatchEvent(new Event('statsUpdated'));
            })
            .catch(error => {
                console.error('Ошибка обновления статистики:', error);
            });
        }

        // Функция сброса фильтров
        function resetFilters() {
            document.getElementById('filter-form').reset();
            document.getElementById('search-input').value = '';
            loadTasks();
        }

        // Обработчик отправки формы фильтрации
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault();
            loadTasks();
        });

        // Обработчик изменения сортировки
        document.getElementById('ordering').addEventListener('change', function() {
            loadTasks();
        });

        function deleteTask(taskId) {
            if (!confirm('Вы уверены, что хотите удалить эту задачу?')) return;

            fetch(`/api/tasks/${taskId}/`, {
                method: 'DELETE',
                headers: {
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Не удалось удалить задачу: ' + response.status);
                }
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-success">Задача успешно удалена!</div>';
                loadTasks();
                updateMainStats();
            })
            .catch(error => {
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + error.message + '</div>';
            });
        }

        // Загрузка задач при загрузке страницы
        loadTasks();
    </script>
{% endblock %}