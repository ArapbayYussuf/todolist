{% extends 'base.html' %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h2 class="text-center mb-4">Создать задачу</h2>
            <form id="create-task-form">
                <div class="mb-3">
                    <label for="title" class="form-label">Название задачи</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label">Описание</label>
                    <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="category" class="form-label">Категория</label>
                    <select class="form-control" id="category" name="category">
                        <option value="">Выберите категорию</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Теги</label>
                    <div id="tags-checkboxes">
                        <!-- Теги будут загружены через JavaScript -->
                    </div>
                </div>
                <button type="submit" class="btn btn-danger w-100">Создать задачу</button>
            </form>
            <div id="task-message" class="mt-3 text-center"></div>
        </div>
    </div>

    <script>
        // Загрузка категорий
        fetch('/api/categories/', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Ошибка загрузки категорий');
                return response.json();
            })
            .then(data => {
                const categorySelect = document.getElementById('category');
                data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    categorySelect.appendChild(option);
                });
            })
            .catch(error => console.error('Ошибка загрузки категорий:', error));

        // Загрузка тегов
        fetch('/api/tags/', {
            headers: {
                'Authorization': 'Bearer ' + localStorage.getItem('access_token')
            }
        })
            .then(response => {
                if (!response.ok) throw new Error('Ошибка загрузки тегов');
                return response.json();
            })
            .then(data => {
                const tagsContainer = document.getElementById('tags-checkboxes');
                data.forEach(tag => {
                    const tagDiv = document.createElement('div');
                    tagDiv.className = 'form-check form-check-inline';
                    tagDiv.innerHTML = `
                        <input class="form-check-input" type="checkbox" name="tags" id="tag-${tag.id}" value="${tag.id}">
                        <label class="form-check-label" for="tag-${tag.id}">${tag.name}</label>
                    `;
                    tagsContainer.appendChild(tagDiv);
                });
            })
            .catch(error => console.error('Ошибка загрузки тегов:', error));

        // Отправка формы
        document.getElementById('create-task-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(this);
            const tags = Array.from(document.querySelectorAll('input[name="tags"]:checked')).map(input => parseInt(input.value));
            const taskData = {
                title: formData.get('title'),
                description: formData.get('description'),
                category: formData.get('category') ? parseInt(formData.get('category')) : null,
                tags: tags.length > 0 ? tags : []
            };

            console.log('Отправляемые данные:', taskData); // Для отладки

            fetch('/api/tasks/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + localStorage.getItem('access_token')
                },
                body: JSON.stringify(taskData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(data => {
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-success">Задача успешно создана!</div>';
                this.reset();
            })
            .catch(error => {
                const messageDiv = document.getElementById('task-message');
                messageDiv.innerHTML = '<div class="alert alert-danger">Ошибка: ' + JSON.stringify(error) + '</div>';
            });
        });
    </script>
{% endblock %}